{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Exam Page</title>
  <!-- Bootstrap CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <style>
    .logo {
      height: 40px;
      width: auto;
    }
    .navbar {
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      background-color: white;
      padding: 10px 0;
    }
    .timer {
      font-size: 1.2rem;
      font-weight: bold;
    }
    .question-card {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 30px;
      margin-bottom: 20px;
      background-color: #f8f9fa;
      min-height: 400px;
    }
    .option-tile {
      padding: 15px;
      border: 1px solid #ccc;
      border-radius: 5px;
      margin: 10px 0;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .option-tile input[type="radio"] {
      margin: 0;
      cursor: pointer;
    }
    .option-tile label {
      margin: 0;
      cursor: pointer;
    }
    .option-tile:hover,
    .selected {
      background-color: #0d6efd;
      color: white;
    }
    .submit-btn {
      background-color: #198754;
      color: white;
      font-size: 1.2rem;
    }
    .question-hidden {
      display: none;
    }
    .navigation-btn {
      font-size: 1.1rem;
      padding: 10px 30px;
    }
    .question-timer {
      font-size: 1.5rem;
      font-weight: bold;
      color: #dc3545;
    }
    .progress-bar-container {
      margin-bottom: 20px;
    }
    #warning-alert {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      background-color: #FF0000;
      color: white;
      font-weight: bold;
      display: none;
    }
  </style>
</head>

<body>
  <!-- Navbar with Logo -->
  <nav class="navbar navbar-expand-lg navbar-light">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">
        <img src="{% static 'images/logoArcite.png' %}" alt="ArciteProctor Logo" class="logo">
      </a>
    </div>
  </nav>

  <div class="container mt-5">
    <div class="row">
      <div class="col-md-8 offset-md-2">
        <h1 class="text-center mb-4 text-primary">Exam Portal</h1>

        <!-- Exam Info -->
        <div class="text-center mb-3">
          <p>
            <strong>Full Marks:</strong> 100 |
            <strong>Pass Marks:</strong> 40
          </p>
        </div>

        <!-- Tab Switch Counter -->
        <div class="alert alert-danger text-center" id="tab-warning">
          Tab Switches: <span id="tab-count">{{ tab_count }}</span>/5
        </div>

        <!-- Progress Bar -->
        <div class="progress-bar-container">
          <div class="progress">
            <div id="progress-bar" class="progress-bar progress-bar-striped" role="progressbar" style="width: 0%"></div>
          </div>
          <p class="text-center mt-2">Question <span id="current-question-num">1</span> of <span id="total-questions">{{ questions|length }}</span></p>
        </div>

        <!-- Question Timer -->
        <div id="question-timer" class="question-timer text-center mb-3">
          Time for this question: <span id="question-time">20</span>s
        </div>

        <!-- Questions -->
        <form id="exam-form" method="post" action="{% url 'submit_exam' %}">
          {% csrf_token %}
          <input type="hidden" name="username" value="{{ user.first_name }}" />

          {% for question in questions %}
          <div class="question-card question-slide" data-question-index="{{ forloop.counter0 }}" style="{% if forloop.counter0 != 0 %}display: none;{% endif %}">
            <p class="question-text fs-5 mb-4">
              <strong>Question {{ forloop.counter }}:</strong> {{ question.text }}
            </p>
            <div class="option-tile" onclick="selectOption(this, 'q{{ question.id }}a')">
              <input
                type="radio"
                name="answer_{{ question.id }}"
                id="q{{ question.id }}a"
                value="A"
              />
              <label for="q{{ question.id }}a" class="w-100 cursor-pointer">A. {{ question.option_a }}</label>
            </div>
            <div class="option-tile" onclick="selectOption(this, 'q{{ question.id }}b')">
              <input type="radio" name="answer_{{ question.id }}" id="q{{ question.id }}b" value="B" />
              <label for="q{{ question.id }}b" class="w-100 cursor-pointer">B. {{ question.option_b }}</label>
            </div>
            <div class="option-tile" onclick="selectOption(this, 'q{{ question.id }}c')">
              <input type="radio" name="answer_{{ question.id }}" id="q{{ question.id }}c" value="C" />
              <label for="q{{ question.id }}c" class="w-100 cursor-pointer">C. {{ question.option_c }}</label>
            </div>
            <div class="option-tile" onclick="selectOption(this, 'q{{ question.id }}d')">
              <input type="radio" name="answer_{{ question.id }}" id="q{{ question.id }}d" value="D" />
              <label for="q{{ question.id }}d" class="w-100 cursor-pointer">D. {{ question.option_d }}</label>
            </div>
          </div>
          {% endfor %}

          <!-- Navigation Buttons -->
          <div class="d-flex justify-content-between mt-4">
            <button type="button" id="prev-btn" class="btn btn-secondary navigation-btn" onclick="previousQuestion()" disabled>
              ← Previous
            </button>
            <button type="button" id="next-btn" class="btn btn-primary navigation-btn" onclick="nextQuestion()">
              Next →
            </button>
            <button type="submit" id="submit-btn" class="btn submit-btn navigation-btn" style="display: none;">
              Submit Exam
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Real-time warning alert -->
  <div id="warning-alert" class="alert"></div>

<script>
    // Question navigation
    let currentQuestionIndex = 0;
    const totalQuestions = {{ questions|length }};
    const questionSlides = document.querySelectorAll('.question-slide');
    
    // Question timer
    let questionTimeLeft = 20;
    let questionTimerInterval;

    function startQuestionTimer() {
      clearInterval(questionTimerInterval);
      questionTimeLeft = 20;
      const questionTimeElement = document.getElementById("question-time");
      
      questionTimerInterval = setInterval(() => {
        questionTimeLeft--;
        questionTimeElement.textContent = questionTimeLeft;
        
        if (questionTimeLeft === 0) {
          clearInterval(questionTimerInterval);
          if (currentQuestionIndex < totalQuestions - 1) {
            nextQuestion();
          } else {
            alert("Time's up! Submitting the exam.");
            document.getElementById("exam-form").submit();
          }
        }
      }, 1000);
    }

    function showQuestion(index) {
      questionSlides.forEach(slide => {
        slide.style.display = 'none';
      });
      
      questionSlides[index].style.display = 'block';
      
      const progress = ((index + 1) / totalQuestions) * 100;
      document.getElementById('progress-bar').style.width = progress + '%';
      document.getElementById('current-question-num').textContent = index + 1;
      
      document.getElementById('prev-btn').disabled = (index === 0);
      
      if (index === totalQuestions - 1) {
        document.getElementById('next-btn').style.display = 'none';
        document.getElementById('submit-btn').style.display = 'block';
      } else {
        document.getElementById('next-btn').style.display = 'block';
        document.getElementById('submit-btn').style.display = 'none';
      }
      
      startQuestionTimer();
    }

    function nextQuestion() {
      if (currentQuestionIndex < totalQuestions - 1) {
        currentQuestionIndex++;
        showQuestion(currentQuestionIndex);
      }
    }

    function previousQuestion() {
      if (currentQuestionIndex > 0) {
        currentQuestionIndex--;
        showQuestion(currentQuestionIndex);
      }
    }

    function selectOption(optionTile, inputId) {
      const questionCard = optionTile.closest(".question-card");
      questionCard.querySelectorAll(".option-tile").forEach((tile) => {
        tile.classList.remove("selected");
      });
      optionTile.classList.add("selected");
      document.getElementById(inputId).checked = true;
    }

    window.onload = function() {
      document.getElementById('total-questions').textContent = totalQuestions;
      startQuestionTimer();
      document.documentElement.requestFullscreen();
    };

    function checkWarnings() {
      fetch("/get_warning/")
        .then((response) => response.json())
        .then((data) => {
          if (data.warning) {
            const warningAlert = document.getElementById("warning-alert");
            warningAlert.textContent = data.warning;
            warningAlert.style.display = "block";
          }
        });
    }
    setInterval(checkWarnings, 5000);

    document.addEventListener("contextmenu", (e) => e.preventDefault());

    // Initialize tab switch count
    let tabSwitchCount = {{ tab_count|default:0 }};
    let lastVisibilityState = document.visibilityState;
    let isRecordingSwitch = false;

    function tabSwitchHandler() {
      if (lastVisibilityState === 'visible' && document.visibilityState === 'hidden') {
        if (!isRecordingSwitch) {
          recordTabSwitch("⚠️ Tab switch detected!");
        }
      }
      lastVisibilityState = document.visibilityState;
    }
    document.addEventListener("visibilitychange", tabSwitchHandler);

    function showWarning(msg) {
      const alertBox = document.getElementById("warning-alert");
      alertBox.textContent = msg;
      alertBox.style.display = "block";
      setTimeout(() => (alertBox.style.display = "none"), 4000);
    }

    function recordTabSwitch(warningMsg) {
      if (isRecordingSwitch) return;
      
      isRecordingSwitch = true;
      tabSwitchCount++;
      document.getElementById("tab-count").textContent = tabSwitchCount;
      
      if (warningMsg) {
        showWarning(warningMsg);
      }

      fetch("{% url 'record_tab_switch' %}", {
        method: "POST",
        headers: {
          "X-CSRFToken": "{{ csrf_token }}",
          "Content-Type": "application/json"
        },
      })
      .then(response => response.json())
      .then(data => {
        // Check server response OR local count
        if (data.status === "terminated" || data.count >= 5 || tabSwitchCount >= 5) {
          // Immediately disable all exam functionality
          window.onbeforeunload = null;
          document.removeEventListener("visibilitychange", tabSwitchHandler);
          clearInterval(questionTimerInterval);
          
          // Alert and redirect
          alert("Your exam has been terminated due to excessive tab switching.");
          window.location.href = "{% url 'exam_submission_success' %}";
        }
      })
      .catch(error => {
        console.error('Error:', error);
        // Even if server fails, check local count
        if (tabSwitchCount >= 5) {
          window.onbeforeunload = null;
          alert("Your exam has been terminated due to excessive tab switching.");
          window.location.href = "{% url 'exam_submission_success' %}";
        }
      })
      .finally(() => {
        // Shorter debounce: 300ms
        setTimeout(() => {
          isRecordingSwitch = false;
        }, 300);
      });
    }

    window.addEventListener("blur", () => {
      window.focus();
    });

    document.addEventListener("fullscreenchange", () => {
      if (!document.fullscreenElement) {
        showWarning("⚠️ You cannot exit fullscreen mode!");
        document.documentElement.requestFullscreen();
      }
    });

    window.onbeforeunload = function () {
      return "You are in the middle of an exam! Are you sure you want to leave?";
    };

    document.getElementById("exam-form").addEventListener("submit", function () {
      window.onbeforeunload = null;
      document.removeEventListener("visibilitychange", tabSwitchHandler);
      clearInterval(questionTimerInterval);
    });
</script>
</body>
</html>